"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerTool = registerTool;
const v4_1 = require("zod/v4");
const models_1 = require("./models");
const registry_1 = require("./registry");
// Implementation
function registerTool(name, options, handler) {
    // Register the tool with all services
    const responseType = options.type || "json";
    for (const service of registry_1.registry.services) {
        service.registerTool(name, options.description, handler, jsonSchemaToParameters(v4_1.z.toJSONSchema(v4_1.z.object(options.inputSchema))), `/tools/${name.replace(/_/g, "-")}`, options.authRequirements
            ? [
                new models_1.AuthRequirement(options.authRequirements.provider, options.authRequirements.scopeBundle, options.authRequirements.required ?? true),
            ]
            : undefined, responseType, true);
    }
    return handler;
}
/**
 * Convert JSON Schema to Parameter definitions
 * This converts the output of z.toJSONSchema() back to the Parameter[] format
 * expected by the legacy discovery endpoint
 */
function jsonSchemaToParameters(jsonSchema) {
    const parameters = [];
    if (!jsonSchema.properties) {
        return parameters;
    }
    const required = jsonSchema.required || [];
    for (const [key, value] of Object.entries(jsonSchema.properties)) {
        const prop = value;
        parameters.push(new models_1.Parameter(key, jsonSchemaTypeToParameterType(prop.type || "string"), prop.description || "", required.includes(key)));
    }
    return parameters;
}
/**
 * Map JSON Schema type to ParameterType
 */
function jsonSchemaTypeToParameterType(jsonType) {
    switch (jsonType) {
        case "array":
            return models_1.ParameterType.List;
        case "boolean":
            return models_1.ParameterType.Boolean;
        case "integer":
            return models_1.ParameterType.Integer;
        case "number":
            return models_1.ParameterType.Number;
        case "object":
            return models_1.ParameterType.Dictionary;
        case "string":
            return models_1.ParameterType.String;
        default:
            return models_1.ParameterType.String;
    }
}
