"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.tool = tool;
/* eslint-disable @typescript-eslint/no-explicit-any */
require("reflect-metadata");
const models_1 = require("./models");
const registry_1 = require("./registry");
/**
 * Decorator to register a function as an Opal tool
 * @param options Tool options including:
 *   - name: Name of the tool
 *   - description: Description of the tool
 *   - authRequirements: (Optional) Authentication requirements
 *     Format: { provider: "oauth_provider", scopeBundle: "permissions_scope", required: true }
 *     Example: { provider: "google", scopeBundle: "calendar", required: true }
 *
 * Note: If your tool requires authentication, define your handler function with two parameters:
 * ```
 * async function myTool(parameters: ParameterInterface, authData?: any): Promise<any> {
 *   // Your tool implementation
 * }
 * ```
 */
function tool(options) {
    return function (target, propertyKey, descriptor) {
        const isMethod = propertyKey && descriptor;
        const handler = isMethod ? descriptor.value : target;
        // Generate endpoint from name - ensure hyphens instead of underscores
        const endpoint = `/tools/${options.name.replace(/_/g, "-")}`;
        // Convert parameter definitions to Parameter objects
        const parameters = [];
        if (options.parameters && options.parameters.length > 0) {
            // Use the explicitly provided parameter definitions
            for (const paramDef of options.parameters) {
                parameters.push(new models_1.Parameter(paramDef.name, paramDef.type, paramDef.description, paramDef.required));
            }
        }
        // Create auth requirements if specified
        let authRequirements;
        if (options.authRequirements) {
            authRequirements = [
                new models_1.AuthRequirement(options.authRequirements.provider, options.authRequirements.scopeBundle, options.authRequirements.required ?? true),
            ];
        }
        // Register the tool with all services
        for (const service of registry_1.registry.services) {
            service.registerTool(options.name, options.description, handler, parameters, endpoint, authRequirements);
        }
        return isMethod ? descriptor : target;
    };
}
