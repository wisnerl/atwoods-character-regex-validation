/**
 * Tests for Express integration with the registerTool() function
 */

import express from "express";
import request from "supertest";
import { afterEach, beforeEach, describe, expect, test } from "vitest";
import { z } from "zod/v4";

import { Block, ParameterType, registerTool, tool, ToolsService } from "../src";
import { registry } from "../src/registry";

// Clear registry before each test
beforeEach(() => {
  registry.services = [];
});

afterEach(() => {
  registry.services = [];
});

describe("Integration Tests", () => {
  test("simple tool endpoint", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    registerTool(
      "greet",
      {
        description: "Greet a user",
        inputSchema: {
          name: z.string().describe("The name to greet"),
        },
      },
      async (params) => {
        return `Hello, ${params.name}!`;
      },
    );

    // Call the endpoint
    const response = await request(app)
      .post("/tools/greet")
      .send({ parameters: { name: "Alice" } });

    expect(response.status).toBe(200);
    // Verify correct content-type header for regular tools
    expect(response.headers["content-type"]).toMatch(/application\/json/);
    expect(response.body).toBe("Hello, Alice!");
  });

  test("block tool endpoint correctly serializes all fields", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    registerTool(
      "create_task",
      {
        description: "Create a task",
        inputSchema: {
          name: z.string().describe("Task name"),
        },
        type: "block",
      },
      async (params) => {
        return {
          artifact: {
            data: { name: params.name },
            id: "task-123",
            type: "task",
          },
          content: Block.Document({
            children: Block.Text({ children: `Created task: ${params.name}` }),
          }),
          data: { created_at: "2024-01-01T00:00:00Z" },
          rollback: {
            config: { endpoint: "/api/tasks/task-123", method: "DELETE" },
            label: "Delete Task",
            type: "endpoint",
          },
        };
      },
    );

    const response = await request(app)
      .post("/tools/create-task")
      .send({ parameters: { name: "My Task" } });

    expect(response.status).toBe(200);
    expect(response.headers["content-type"]).toBe(
      "application/vnd.opal.block+json; charset=utf-8",
    );
    expect(response.body).toEqual({
      artifact: { data: { name: "My Task" }, id: "task-123", type: "task" },
      content: {
        $type: "Block.Document",
        children: { $type: "Block.Text", children: "Created task: My Task" },
      },
      data: { created_at: "2024-01-01T00:00:00Z" },
      rollback: {
        config: { endpoint: "/api/tasks/task-123", method: "DELETE" },
        label: "Delete Task",
        type: "endpoint",
      },
    });
  });

  test("environment parameter is correctly passed to tool", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    registerTool(
      "check_env",
      {
        description: "Check environment",
        inputSchema: {
          name: z.string().describe("Name parameter"),
        },
      },
      async (params, extra) => {
        return {
          has_environment: extra !== undefined,
          param_name: params.name,
        };
      },
    );

    const response = await request(app)
      .post("/tools/check-env")
      .send({ parameters: { name: "Test" } });

    expect(response.status).toBe(200);
    expect(response.body).toEqual({
      has_environment: true,
      param_name: "Test",
    });
  });

  test("invalid parameters return proper error", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    registerTool(
      "validate_params",
      {
        description: "Validate parameters",
        inputSchema: {
          name: z.string().describe("Required name"),
        },
      },
      async (params) => {
        if (!params.name) {
          throw new Error("Name is required");
        }
        return `Valid: ${params.name}`;
      },
    );

    // Call with missing required parameter
    const response = await request(app)
      .post("/tools/validate-params")
      .send({ parameters: {} });

    expect(response.status).toBe(500);
    expect(response.body).toHaveProperty("error");
  });

  test("multiple tools on same service and discovery endpoint", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    // Use legacy @tool decorator for first tool by calling it as a function
    const getWeatherHandler = async () => {
      return { condition: "sunny", temperature: 22 };
    };

    tool({
      description: "Gets current weather for a location",
      name: "get_weather",
      parameters: [
        {
          description: "City name or location",
          name: "location",
          required: true,
          type: ParameterType.String,
        },
        {
          description: "Temperature units",
          name: "units",
          required: false,
          type: ParameterType.String,
        },
      ],
    })(getWeatherHandler);

    // Use modern registerTool for second tool
    registerTool(
      "create_task",
      {
        authRequirements: {
          provider: "google",
          required: true,
          scopeBundle: "tasks",
        },
        description: "Create a new task",
        inputSchema: {
          title: z.string().describe("Task title"),
        },
        type: "block",
      },
      async (params) => {
        return {
          content: Block.Document({
            children: Block.Text({ children: `Task: ${params.title}` }),
          }),
        };
      },
    );

    // Test both tool endpoints work
    const weatherResponse = await request(app)
      .post("/tools/get-weather")
      .send({ parameters: { location: "San Francisco" } });
    const taskResponse = await request(app)
      .post("/tools/create-task")
      .send({ parameters: { title: "My Task" } });

    expect(weatherResponse.status).toBe(200);
    expect(taskResponse.status).toBe(200);

    // Test discovery endpoint
    const discoveryResponse = await request(app).get("/discovery");

    expect(discoveryResponse.status).toBe(200);
    expect(discoveryResponse.headers["content-type"]).toMatch(
      /application\/json/,
    );
    expect(discoveryResponse.body).toEqual({
      functions: [
        {
          description: "Gets current weather for a location",
          endpoint: "/tools/get-weather",
          http_method: "POST",
          name: "get_weather",
          parameters: [
            {
              description: "City name or location",
              name: "location",
              required: true,
              type: "string",
            },
            {
              description: "Temperature units",
              name: "units",
              required: false,
              type: "string",
            },
          ],
        },
        {
          auth_requirements: [
            {
              provider: "google",
              required: true,
              scope_bundle: "tasks",
            },
          ],
          description: "Create a new task",
          endpoint: "/tools/create-task",
          http_method: "POST",
          name: "create_task",
          parameters: [
            {
              description: "Task title",
              name: "title",
              required: true,
              type: "string",
            },
          ],
        },
      ],
    });
  });

  test("block tool without BlockResponse throws error", async () => {
    const app = express();
    app.use(express.json());
    new ToolsService(app);

    // @ts-expect-error - Testing runtime validation of invalid block tool return type
    registerTool(
      "invalid_block",
      {
        description: "Block tool that returns wrong type",
        inputSchema: {
          name: z.string().describe("Name"),
        },
        type: "block",
      },
      async (params) => {
        // This should fail - block tools must return BlockResponse
        return `This should fail: ${params.name}`;
      },
    );

    const response = await request(app)
      .post("/tools/invalid-block")
      .send({ parameters: { name: "Test" } });

    // Should return 500 error because block tools must return BlockResponse
    expect(response.status).toBe(500);
    expect(response.body.error).toContain("must return a BlockResponse object");
  });
});
